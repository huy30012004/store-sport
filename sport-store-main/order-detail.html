<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chi ti·∫øt ƒë∆°n h√†ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- load CSS, gi·ªØ nguy√™n <i> v√† class ƒë·ªÉ JS c·ªßa b·∫°n toggle -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"
/>

  <style>
    .star.text-yellow-400 { color: #f6c23e; }
    .star.text-gray-300  { color: #d1d5db; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto px-4 py-8">
    <button onclick="history.back()"
            class="mb-6 text-blue-600 hover:underline">&larr; Quay l·∫°i</button>

    <div id="orderDetailContainer" class="bg-white rounded-lg shadow p-6">
      <p class="text-gray-500">ƒêang t·∫£i chi ti·∫øt ƒë∆°n h√†ng‚Ä¶</p>
    </div>
  </div>

  <script>
    console.log('üî∞ order-detail.js b·∫Øt ƒë·∫ßu t·∫£i'); 

    const apiBase = 'http://localhost:5000/api';

    function getOrderIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    async function loadOrderDetail() {
      console.log('‚ñ∂ loadOrderDetail() g·ªçi');
      const id = getOrderIdFromURL();
      const container = document.getElementById('orderDetailContainer');
      if (!id) {
        container.innerHTML = '<p class="text-red-500">Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ID ƒë∆°n h√†ng.</p>';
        return;
      }

      try {
        const res = await fetch(`${apiBase}/orders/${id}`);
        if (!res.ok) throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c chi ti·∫øt ƒë∆°n.');
        const o = await res.json();

        let html = `
          <h1 class="text-2xl font-bold mb-4">Chi ti·∫øt ƒë∆°n #${o.id}</h1>
          <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Th√¥ng tin kh√°ch h√†ng</h2>
            <p><span class="font-medium">Email:</span> ${o.customer || o.customerEmail || '-'}</p>
            ${o.customerName? `<p><span class="font-medium">H·ªç t√™n:</span> ${o.customerName}</p>`: ''}
            ${o.customerPhone? `<p><span class="font-medium">SƒêT:</span> ${o.customerPhone}</p>`: ''}
            ${o.customerAddress? `<p><span class="font-medium">ƒê·ªãa ch·ªâ:</span> ${o.customerAddress}</p>`: ''}
            ${o.note? `<p><span class="font-medium">Ghi ch√∫:</span> ${o.note}</p>`: ''}
            <p><span class="font-medium">Th·ªùi gian ƒë·∫∑t:</span> ${new Date(o.created_at).toLocaleString('vi-VN')}</p>
          </div>

          <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t</h2>
            <table class="min-w-full table-auto border-collapse">
              <thead class="bg-gray-200">
                <tr>
                  <th class="px-4 py-2 border">T√™n SP</th>
                  <th class="px-4 py-2 border">Gi√° (ƒë/1)</th>
                  <th class="px-4 py-2 border">Size</th>
                  <th class="px-4 py-2 border">S·ªë l∆∞·ª£ng</th>
                  <th class="px-4 py-2 border">Th√†nh ti·ªÅn</th>
                  <th class="px-4 py-2 border">ƒê√°nh gi√°</th>
                </tr>
              </thead>
              <tbody>
        `;

        // V√≤ng l·∫∑p cho t·ª´ng item
        o.items.forEach(item => {
          const price   = Number(item.price).toLocaleString();
          const lineTot = Number(item.price * item.quantity).toLocaleString();
         html += `
            <tr>
              <td class="px-4 py-2 border">${item.name}</td>
              <td class="px-4 py-2 border">${price}ƒë</td>
              <td class="px-4 py-2 border">${item.size||'-'}</td>
              <td class="px-4 py-2 border">${item.quantity}</td>
              <td class="px-4 py-2 border">${lineTot}ƒë</td>
              <td class="px-4 py-2 border text-center">
  <!-- Khung sao (b·∫Øt ƒë·∫ßu v·ªõi outline star) -->
  <div class="rating flex justify-center space-x-1"
       data-order-id="${o.id}"
       data-product-id="${item.id}"
       data-customer="${(o.customer||o.customerEmail||'').toLowerCase()}">
    ${[1,2,3,4,5].map(i =>
      `<i class="far fa-star star cursor-pointer text-gray-300" data-value="${i}"></i>`
    ).join('')}
  </div>

  <!-- Form comment (·∫©n) -->
  <form class="review-form hidden mt-2 space-y-1">
    <textarea class="comment w-full border rounded p-1"
              placeholder="Vi·∫øt nh·∫≠n x√©t‚Ä¶"></textarea>
    <button type="button"
            class="btn-submit-review bg-blue-600 text-white px-3 py-1 rounded">
      G·ª≠i
    </button>
  </form>
</td>



            </tr>
          `;

        });

        html += `
              </tbody>
            </table>
          </div>

          <div class="text-right font-medium text-lg">
            <p>Subtotal: ${Number(o.subtotal||o.total).toLocaleString()}ƒë</p>
            ${o.shippingFee!=null? `<p>Ph√≠ v·∫≠n chuy·ªÉn: ${Number(o.shippingFee).toLocaleString()}ƒë</p>`: ''}
            <p class="mt-2">T·ªïng c·ªông: <span class="text-red-600">${Number(o.total).toLocaleString()}ƒë</span></p>
          </div>
        `;

        container.innerHTML = html;

        // Sau khi render xong, kh·ªüi t·∫°o s·ª± ki·ªán cho ph·∫ßn ƒë√°nh gi√°
        initDetailRatings();

      } catch (err) {
        console.error(err);
        container.innerHTML = '<p class="text-red-500">L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n.</p>';
      }
    }

function highlightStars(rEl, rating) {
    rEl.querySelectorAll('.star').forEach(s => {
      const v = +s.dataset.value;
      s.classList.toggle('fas', v <= rating);
      s.classList.toggle('far', v >  rating);
      s.classList.toggle('text-yellow-400', v <= rating);
      s.classList.toggle('text-gray-300',  v >  rating);
    });
  }

  function initDetailRatings() {
    console.log('‚ñ∂ initDetailRatings() g·ªçi ‚Äì t√¨m th·∫•y', 
              document.querySelectorAll('.rating').length, 
              'rating box');
    document.querySelectorAll('.rating').forEach(rEl => {
      const orderId   = rEl.dataset.orderId;
      const productId = rEl.dataset.productId;
      const email     = rEl.dataset.customer;
      const formEl    = rEl.nextElementSibling;
      const stars     = Array.from(rEl.querySelectorAll('.star'));

      // 1) Ki·ªÉm tra xem ƒë√£ ƒë√°nh gi√° ch∆∞a
      fetch(`${apiBase}/products/${productId}/reviews`)
        .then(r => r.json())
        .then(data => {
          const entry = (data.reviews||[]).find(r => r.name.toLowerCase() === email);
          if (entry) {
            highlightStars(rEl, entry.rating);
            formEl.classList.add('hidden');
          }
        }).catch(()=>{});

      // 2) Click sao ‚Üí highlight + show form
      stars.forEach(star => {
        star.addEventListener('click', () => {
          const v = +star.dataset.value;
          highlightStars(rEl, v);
          formEl.classList.remove('hidden');
          formEl.querySelector('.comment').focus();
        });
      });

      // 3) G·ª≠i ƒë√°nh gi√°
      formEl.querySelector('.btn-submit-review')
        .addEventListener('click', async () => {
          const v       = stars.filter(s => s.classList.contains('fas')).length;
          const comment = formEl.querySelector('.comment').value.trim();
          if (!v) return alert('Ch·ªçn s·ªë sao tr∆∞·ªõc!');
          try {
            const res = await fetch(`${apiBase}/products/${productId}/reviews`, {
              method: 'POST',
              headers: { 'Content-Type':'application/json' },
              body: JSON.stringify({ email, rating: v, comment })
            });
            const body = await res.json();
            if (!res.ok) throw new Error(body.error||JSON.stringify(body));
            alert('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!');
            formEl.classList.add('hidden');
          } catch(e) {
            console.error(e);
            alert('L·ªói: ' + e.message);
          }
        });
    });
  }

    document.addEventListener('DOMContentLoaded', loadOrderDetail);
  </script>
</body>
</html>
